## johnlions ##

### tl;dr ###
The binary `/bin/mv` was set-uid `root`, which meant that you could overwrite
files used for authentication (such as `/etc/passwd` or `/etc/shadow`) and thus
escalate to root privileges.

### Session ###
The following is the logs from a session where the above exploit was used to
read the target file (`/flag`).

```shell
$ find / -type f -user root -perm -4000 -print
/bin/mv
/bin/login
/bin/mail
/bin/mkdir
/bin/newgrp
/bin/passwd
/bin/su
/bin/rmdir
/usr/lib/atrun
$ cat /etc/passwd
root:x:0:1::/:
ctf::7:3::/:
$ cat - > /usr/ctf/passwd
root::0:1::/:
ctf::7:3::/:
$ /bin/mv /usr/ctf/passwd /etc/passwd
mv: /etc/passwd: 644 mode y
$ cat /etc/passwd
root::0:1::/:
ctf::7:3::/:
$ su
# cat /flag
9447{h4cking_like_its_1979}
#
```

### What just happened? ###
Here's a breakdown of the above key commands:

#### `find / -type f -user root -perm -4000 -print` ####

This command is used to find all set-uid binaries owned by `root`. cyphar then
went about reading through each one and seeing which binary (if any) was not
(on a standard system) set-uid `root`. The most likely candidates were
`/bin/mkdir`, `/bin/rmdir` and `/bin/mv`. However, on a classic UNIX system
(such as this challenge was being run on), the syscalls for creating files and
directories must be executed by `root` (auscompgeek realised this from some
quick Googling). Thus, `/bin/mv` would be our attack vector.

#### `cat - > /usr/ctf/passwd` ####

The user we were given access to had `rwx` rights to the directory `/usr/ctf/`.
Since the shell being run was a relatively "dumb" shell (it didn't support
process substitution), in order to use `/bin/mv` to overwrite `/etc/passwd` we
would need to have a location where we could create and write to files.

The data written afterward is a modified `/etc/passwd` file, where `root`'s
password has been disabled (NOTE: the second field of the `root` line is blank,
which is interpreted by `su` as no password authentication required for the
given user).

#### `/bin/mv /usr/ctf/passwd /etc/passwd` ####

This is the exploit. Because `/bin/mv` is set-uid `root`, it can write to
`/etc/passwd` when executed by **any** user. Thus we can replace the system's
authentication files with our own, and log in as any user.

> **NOTE**: Due to the different file modes, you are asked to confirm the
> overwriting of `/etc/passwd`. You just need to provide `y` as the answer to
> continue the exploit (the full prompt doesn't appear in the above session).

#### `su` ####

Since we have overwritten `/etc/passwd`, you can log in as `root` with no
password (NOTE: the change of the prompt from `$` to `#` indicates that the
escalation to root was successful).

#### `cat /flag` ####

This just discloses the information inside the target file, revealing the flag
and completing the challenge.

### Notes ###

* Both cyphar and auscompgeek really hate `telnet` (no line editing and
  backspace doesn't work -- grrr)
* cyphar now appreciates just how much GNU has provided in terms of
  user-friendly tools and features.

### Mitigations ###

In order to make this exploit not work, `/bin/mv` should either implement some
kind of primitive access control (like `su` or other proper set-uid `root`
programs), or have the set-uid mode bit disabled for the binary.
